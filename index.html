<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI exerscice counter</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f2f5; }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; margin: 10px; }
        button:disabled { background: #ccc; }
        #canvas-container { margin: 20px auto; width: 200px; height: 200px; border: 5px solid #333; border-radius: 50%; overflow: hidden; }
        .stat-box { display: inline-block; background: white; padding: 20px; margin: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); width: 150px; }
        .value { font-size: 40px; font-weight: bold; color: #333; }
        .label { display: block; color: #666; margin-bottom: 5px; }
        #status { color: #d9534f; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>AI Chair Rep Counter</h1>
    
    <button id="connectBtn" onclick="connectSerial()">ðŸ”Œ Connect Arduino</button>
    
    <button id="startBtn" onclick="init()" disabled>ðŸ“· Start Camera</button>

    <div id="status">Status: Disconnected</div>

    <div id="canvas-container"><canvas id="canvas"></canvas></div>

    <div>
        <div class="stat-box">
            <span class="label">Pose</span>
            <div class="value" id="pose-view">--</div>
        </div>
        <div class="stat-box">
            <span class="label">Reps</span>
            <div class="value" id="rep-count">0</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

    <script type="text/javascript">
        // --------------------------------------------------------
        // 1. CONFIGURATION - PASTE YOUR URL HERE
        // --------------------------------------------------------
        const URL = "YOUR_TEACHABLE_MACHINE_MODEL_URL_HERE/"; 
        // Example: "https://teachablemachine.withgoogle.com/models/abc12345/"

        let model, webcam, ctx, labelContainer, maxPredictions;
        let port, writer;
        
        // Counting Logic Variables
        let count = 0;
        let isForward = false; // State tracking
        let poseLabel = "";

        // --------------------------------------------------------
        // 2. SERIAL COMMUNICATION (ARDUINO)
        // --------------------------------------------------------
        async function connectSerial() {
            try {
                // Prompt user to select Arduino
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                
                const textEncoder = new TextEncoderStream();
                const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
                writer = textEncoder.writable.getWriter();

                document.getElementById("status").innerText = "Status: Arduino Connected!";
                document.getElementById("status").style.color = "green";
                document.getElementById("connectBtn").disabled = true;
                document.getElementById("startBtn").disabled = false; // Enable camera button
            } catch (e) {
                console.error(e);
                alert("Failed to connect to Arduino. Make sure you use Chrome or Edge.");
            }
        }

        async function sendToArduino(number) {
            if (writer) {
                // Send number followed by newline so Arduino .parseInt() works
                await writer.write(number + "\n");
            }
        }

        // --------------------------------------------------------
        // 3. AI & WEBCAM SETUP
        // --------------------------------------------------------
        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            // Load the model
            model = await tmPose.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            // Setup Webcam
            const size = 200;
            const flip = true; 
            webcam = new tmPose.Webcam(size, size, flip);
            await webcam.setup(); 
            await webcam.play();
            window.requestAnimationFrame(loop);

            // Setup Canvas
            const canvas = document.getElementById("canvas");
            canvas.width = size; canvas.height = size;
            ctx = canvas.getContext("2d");
        }

        async function loop(timestamp) {
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        // --------------------------------------------------------
        // 4. PREDICTION & COUNTING LOGIC
        // --------------------------------------------------------
        async function predict() {
            const { pose, posenetOutput, estimatePoses } = await model.estimatePose(webcam.canvas);
            const prediction = await model.predict(posenetOutput);

            // Assume: Class 0 = Straight, Class 1 = Forward
            // Check which probability is higher
            const probStraight = prediction[0].probability;
            const probForward = prediction[1].probability;

            if (probStraight > 0.80) {
                poseLabel = "Straight";
                document.getElementById("pose-view").innerText = "Sit";
                
                // LOGIC: If we were just "Forward", and now we are "Straight" -> Rep Complete!
                if (isForward == true) {
                    count++;
                    document.getElementById("rep-count").innerText = count;
                    sendToArduino(count); // Send to hardware
                    isForward = false;    // Reset state
                }
            } 
            else if (probForward > 0.80) {
                poseLabel = "Forward";
                document.getElementById("pose-view").innerText = "Bend";
                
                // LOGIC: Mark that we are in the middle of a rep
                isForward = true;
            }

            drawPose(pose);
        }

        function drawPose(pose) {
            if (webcam.canvas) {
                ctx.drawImage(webcam.canvas, 0, 0);
                if (pose) {
                    const minPartConfidence = 0.5;
                    tmPose.drawKeypoints(pose.keypoints, minPartConfidence, ctx);
                    tmPose.drawSkeleton(pose.keypoints, minPartConfidence, ctx);
                }
            }
        }
    </script>
</body>
</html>